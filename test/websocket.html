<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket通道测试</title>
    <style>
        /* 样式保持不变 */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .channel {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0069d9;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .message-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
        }
        .received {
            background-color: #e9ecef;
            text-align: left;
        }
        .sent {
            background-color: #d1ecf1;
            text-align: right;
        }
        .timestamp {
            font-size: 0.8em;
            color: 6c757d;
        }
    </style>
</head>
<body>
    <h1>WebSocket通道测试</h1>
    <p>服务器: <span id="server-info">ws://localhost:8000</span></p>

    <div class="container">
        <div class="channel" id="channel1">
            <h2>通道 1 (/rider/channel)</h2>
            <div id="status1" class="status disconnected">已断开</div>
            <button id="connect1">连接</button>
            <button id="disconnect1" disabled>断开</button>

            <h3>发送消息</h3>
            <input type="text" id="message1" class="message-input" placeholder="输入消息..." disabled>
            <button id="send1" disabled>发送</button>

            <h3>模拟骑手位置数据</h3>
            <button id="simulate-rider1" disabled>发送模拟位置</button>

            <h3>接收消息</h3>
            <div id="messages1" class="messages"></div>
        </div>

        <div class="channel" id="channel2">
            <h2>通道 2 (/restaurant/channel)</h2>
            <div id="status2" class="status disconnected">已断开</div>
            <button id="connect2">连接</button>
            <button id="disconnect2" disabled>断开</button>

            <h3>发送消息</h3>
            <input type="text" id="message2" class="message-input" placeholder="输入消息..." disabled>
            <button id="send2" disabled>发送</button>

            <h3>模拟骑手位置数据</h3>
            <button id="simulate-rider2" disabled>发送模拟位置</button>

            <h3>接收消息</h3>
            <div id="messages2" class="messages"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // 配置
        const SERVER_URL = 'http://localhost:8000';
        let socket1 = null;
        let socket2 = null;

        // DOM元素
        const status1 = document.getElementById('status1');
        const connectBtn1 = document.getElementById('connect1');
        const disconnectBtn1 = document.getElementById('disconnect1');
        const messageInput1 = document.getElementById('message1');
        const sendBtn1 = document.getElementById('send1');
        const simulateRiderBtn1 = document.getElementById('simulate-rider1');
        const messages1 = document.getElementById('messages1');

        const status2 = document.getElementById('status2');
        const connectBtn2 = document.getElementById('connect2');
        const disconnectBtn2 = document.getElementById('disconnect2');
        const messageInput2 = document.getElementById('message2');
        const sendBtn2 = document.getElementById('send2');
        const simulateRiderBtn2 = document.getElementById('simulate-rider2');
        const messages2 = document.getElementById('messages2');

        // 辅助函数
        function formatTimestamp() {
            return new Date().toLocaleTimeString();
        }

        function addMessage(container, message, type) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.innerHTML = `
                <div class="timestamp">${formatTimestamp()}</div>
                <div>${message}</div>
            `;
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        function updateConnectionStatus(channel, connected) {
            const status = document.getElementById(`status${channel}`);
            const connectBtn = document.getElementById(`connect${channel}`);
            const disconnectBtn = document.getElementById(`disconnect${channel}`);
            const messageInput = document.getElementById(`message${channel}`);
            const sendBtn = document.getElementById(`send${channel}`);
            const simulateRiderBtn = document.getElementById(`simulate-rider${channel}`);

            if (connected) {
                status.textContent = '已连接';
                status.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                simulateRiderBtn.disabled = false;
            } else {
                status.textContent = '已断开';
                status.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                messageInput.disabled = true;
                sendBtn.disabled = true;
                simulateRiderBtn.disabled = true;
            }
        }

        // 通道1事件处理
        connectBtn1.addEventListener('click', () => {
            socket1 = io(`${SERVER_URL}/rider/channel`);

            socket1.on('connect', () => {
                updateConnectionStatus(1, true);
                addMessage(messages1, '连接到通道1', 'received');
            });

            socket1.on('message', (data) => {
                addMessage(messages1, `收到消息: ${JSON.stringify(data)}`, 'received');
            });

            socket1.on('response', (data) => {
                addMessage(messages1, `收到响应: ${JSON.stringify(data)}`, 'received');
            });

            socket1.on('location_updated', (data) => {
                addMessage(messages1, `位置更新成功: ${JSON.stringify(data)}`, 'received');
            });

            socket1.on('error', (data) => {
                addMessage(messages1, `错误: ${JSON.stringify(data)}`, 'received');
            });

            socket1.on('disconnect', () => {
                updateConnectionStatus(1, false);
                addMessage(messages1, '从通道1断开', 'received');
            });
        });

        disconnectBtn1.addEventListener('click', () => {
            if (socket1) {
                socket1.disconnect();
                socket1 = null;
            }
        });

        sendBtn1.addEventListener('click', () => {
            const message = messageInput1.value;
            if (message && socket1) {
                socket1.emit('message', { text: message, channel: 1 });
                addMessage(messages1, `发送: ${message}`, 'sent');
                messageInput1.value = '';
            }
        });

        simulateRiderBtn1.addEventListener('click', () => {
            if (socket1) {
                // 生成模拟骑手位置数据
                const riderId = Math.floor(Math.random() * 10) + 1; // 1~10
                const latitude = 39.9 + (Math.random() - 0.5) * 0.1;
                const longitude = 116.4 + (Math.random() - 0.5) * 0.1;

                const riderData = {
                    rider_id: riderId,
                    latitude: latitude,
                    longitude: longitude,
                    accuracy: Math.random() * 10,
                    speed: Math.random() * 30,
                    timestamp: new Date().toISOString()
                };

                // 修改这里：发送 location_update 事件而不是 rider_location
                socket1.emit('location_update', riderData);
                addMessage(messages1, `发送骑手位置: ${JSON.stringify(riderData)}`, 'sent');
            }
        });

        // 通道2事件处理
        connectBtn2.addEventListener('click', () => {
            socket2 = io(`${SERVER_URL}/restaurant/channel`);

            socket2.on('connect', () => {
                updateConnectionStatus(2, true);
                addMessage(messages2, '连接到通道2', 'received');
            });

            socket2.on('message', (data) => {
                addMessage(messages2, `收到消息: ${JSON.stringify(data)}`, 'received');
            });

            socket2.on('response', (data) => {
                addMessage(messages2, `收到响应: ${JSON.stringify(data)}`, 'received');
            });

            socket2.on('location_updated', (data) => {
                addMessage(messages2, `位置更新成功: ${JSON.stringify(data)}`, 'received');
            });

            socket2.on('error', (data) => {
                addMessage(messages2, `错误: ${JSON.stringify(data)}`, 'received');
            });

            socket2.on('disconnect', () => {
                updateConnectionStatus(2, false);
                addMessage(messages2, '从通道2断开', 'received');
            });
        });

        disconnectBtn2.addEventListener('click', () => {
            if (socket2) {
                socket2.disconnect();
                socket2 = null;
            }
        });

        sendBtn2.addEventListener('click', () => {
            const message = messageInput2.value;
            if (message && socket2) {
                socket2.emit('message', { text: message, channel: 2 });
                addMessage(messages2, `发送: ${message}`, 'sent');
                messageInput2.value = '';
            }
        });

        simulateRiderBtn2.addEventListener('click', () => {
            if (socket2) {
                // 生成模拟骑手位置数据
                const riderId = Math.floor(Math.random() * 10) + 1; // 1~10
                const latitude = 39.9 + (Math.random() - 0.5) * 0.1;
                const longitude = 116.4 + (Math.random() - 0.5) * 0.1;

                const riderData = {
                    rider_id: riderId,
                    latitude: latitude,
                    longitude: longitude,
                    accuracy: Math.random() * 10,
                    speed: Math.random() * 30,
                    timestamp: new Date().toISOString()
                };

                // 修改这里：发送 location_update 事件而不是 rider_location
                socket2.emit('location_update', riderData);
                addMessage(messages2, `发送骑手位置: ${JSON.stringify(riderData)}`, 'sent');
            }
        });

        // 允许按Enter键发送消息
        messageInput1.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn1.click();
            }
        });

        messageInput2.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn2.click();
            }
        });
    </script>
</body>
</html>